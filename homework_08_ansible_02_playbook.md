# devops-netology DEVSYS-PDC-2

### DEVSYS-PDC-2 ansible 08.02 Vladimir Baksheev / Владимир Бакшеев Домашнее задание к занятию «08.02 Работа с Playbook»

# Домашнее задание к занятию "08.02 Работа с Playbook"

## Подготовка к выполнению

1. (Необязательно) Изучите, что такое [clickhouse](https://www.youtube.com/watch?v=fjTNS2zkeBs) и [vector](https://www.youtube.com/watch?v=CgEhyffisLY)
2. Создайте свой собственный (или используйте старый) публичный репозиторий на github с произвольным именем.
3. Скачайте [playbook](./playbook/) из репозитория с домашним заданием и перенесите его в свой репозиторий.
4. Подготовьте хосты в соответствии с группами из предподготовленного playbook.

## Основная часть

1. Приготовьте свой собственный inventory файл `prod.yml`.

```answer1
    Добавил имя сервера с виртуальной машиной в YC с работающей 
    Ubuntu 20.04 - по алиасу, прописанному в ~./ssh/config файле таким 
    образом, чтобы подключение через ssh происходило без затруднений.
    
    Также переписал изначальный playbook таким образом, чтобы скачивались 
    deb-пакеты и устанавливались на Debian совместимую систему (у меня 
    просто исторически был доступен сервер именно с Ubuntu, на котором я 
    и делал первоначальные эксперименты.
```
```yaml
---
clickhouse:
  hosts:
    clickhouse-01:
      ansible_host: ycubuntu

```

2. Допишите playbook: нужно сделать ещё один play, который устанавливает и настраивает [vector](https://vector.dev).

```answer2
    У Vector скачивать потребовалось только один готовый deb-пакет, что 
    упростило playbook. Также, хоть я и добавил ссылку на конкретную версию, 
    но также включил и обработку ошибки скачивание ссылкой на latest версию.
```

3. При создании tasks рекомендую использовать модули: `get_url`, `template`, `unarchive`, `file`.
4. Tasks должны: скачать нужной версии дистрибутив, выполнить распаковку в выбранную директорию, установить vector.

```bash
bvm@bvm-HP-EliteBook-8470p:~/netology/ansible_8_2/playbook$ ansible-playbook site.yml -i ./inventory/prod.yml 

PLAY [Install Clickhouse] ******************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get clickhouse distrib] **************************************************************************************************************************************************
changed: [clickhouse-01] => (item=clickhouse-client)
changed: [clickhouse-01] => (item=clickhouse-server)
failed: [clickhouse-01] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.deb", "elapsed": 0, "item": "clickhouse-common-static", "msg": "Request failed", "response": "HTTP Error 404: Not Found", "status_code": 404, "url": "https://packages.clickhouse.com/deb/pool/stable/clickhouse-common-static_22.3.3.44_all.deb"}

TASK [Get clickhouse distrib] **************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Install clickhouse packages] *********************************************************************************************************************************************
changed: [clickhouse-01] => (item=clickhouse-common-static-22.3.3.44.deb)
changed: [clickhouse-01] => (item=clickhouse-client-22.3.3.44.deb)
changed: [clickhouse-01] => (item=clickhouse-server-22.3.3.44.deb)

TASK [Start clickhouse service] ************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Create database] *********************************************************************************************************************************************************
changed: [clickhouse-01]

RUNNING HANDLER [Restart clickhouse service] ***********************************************************************************************************************************
changed: [clickhouse-01]

PLAY [Install latest Vector] ***************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get vector distrib] ******************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Install vector package] **************************************************************************************************************************************************
changed: [clickhouse-01]

TASK [Start vector service] ****************************************************************************************************************************************************
ok: [clickhouse-01]

RUNNING HANDLER [Restart vector service] ***************************************************************************************************************************************
changed: [clickhouse-01]

PLAY RECAP *********************************************************************************************************************************************************************
clickhouse-01              : ok=11   changed=8    unreachable=0    failed=0    skipped=0    rescued=1    ignored=0   

```

5. Запустите `ansible-lint site.yml` и исправьте ошибки, если они есть.

```answer5
    Были замечания о том, что не заданы права доступа к создаваемым файлам 
    с deb-пакетами, после их скачивания. Также нужно было везде, где это 
    необходимо, использовать префикс ansible.builtin.
    Исправлено, замечаний больше нет:
```
```bash
bvm@bvm-HP-EliteBook-8470p:~/netology/ansible_8_2/playbook$ ansible-lint site.yml 
WARNING  Overriding detected file kind 'yaml' with 'playbook' for given positional argument: site.yml
bvm@bvm-HP-EliteBook-8470p:~/netology/ansible_8_2/playbook$ 
```

6. Попробуйте запустить playbook на этом окружении с флагом `--check`.

```bash
bvm@bvm-HP-EliteBook-8470p:~/netology/ansible_8_2/playbook$ ansible-playbook site.yml -i ./inventory/prod.yml --check

PLAY [Install Clickhouse] ******************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get clickhouse distrib] **************************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
failed: [clickhouse-01] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.deb", "elapsed": 0, "gid": 1001, "group": "ubuntu", "item": "clickhouse-common-static", "mode": "0664", "msg": "Request failed", "owner": "ubuntu", "response": "HTTP Error 404: Not Found", "size": 246378832, "state": "file", "status_code": 404, "uid": 1000, "url": "https://packages.clickhouse.com/deb/pool/stable/clickhouse-common-static_22.3.3.44_all.deb"}

TASK [Get clickhouse distrib] **************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install clickhouse packages] *********************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-common-static-22.3.3.44.deb)
ok: [clickhouse-01] => (item=clickhouse-client-22.3.3.44.deb)
ok: [clickhouse-01] => (item=clickhouse-server-22.3.3.44.deb)

TASK [Start clickhouse service] ************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [debug] *******************************************************************************************************************************************************************
ok: [clickhouse-01] => {
    "service_status_var.status.ActiveState": "active"
}

TASK [Create database] *********************************************************************************************************************************************************
skipping: [clickhouse-01]

PLAY [Install latest Vector] ***************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get vector distrib] ******************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install vector package] **************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Start vector service] ****************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [debug] *******************************************************************************************************************************************************************
ok: [clickhouse-01] => {
    "service_status_var.status.ActiveState": "active"
}

PLAY RECAP *********************************************************************************************************************************************************************
clickhouse-01              : ok=10   changed=0    unreachable=0    failed=0    skipped=1    rescued=1    ignored=0   

```

7. Запустите playbook на `prod.yml` окружении с флагом `--diff`. Убедитесь, что изменения на системе произведены.

```bash
bvm@bvm-HP-EliteBook-8470p:~/netology/ansible_8_2/playbook$ ansible-playbook site.yml -i ./inventory/prod.yml --diff

PLAY [Install Clickhouse] ******************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get clickhouse distrib] **************************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
failed: [clickhouse-01] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.deb", "elapsed": 0, "gid": 1001, "group": "ubuntu", "item": "clickhouse-common-static", "mode": "0664", "msg": "Request failed", "owner": "ubuntu", "response": "HTTP Error 404: Not Found", "size": 246378832, "state": "file", "status_code": 404, "uid": 1000, "url": "https://packages.clickhouse.com/deb/pool/stable/clickhouse-common-static_22.3.3.44_all.deb"}

TASK [Get clickhouse distrib] **************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install clickhouse packages] *********************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-common-static-22.3.3.44.deb)
ok: [clickhouse-01] => (item=clickhouse-client-22.3.3.44.deb)
ok: [clickhouse-01] => (item=clickhouse-server-22.3.3.44.deb)

TASK [Start clickhouse service] ************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [debug] *******************************************************************************************************************************************************************
ok: [clickhouse-01] => {
    "service_status_var.status.ActiveState": "active"
}

TASK [Create database] *********************************************************************************************************************************************************
ok: [clickhouse-01]

PLAY [Install latest Vector] ***************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get vector distrib] ******************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install vector package] **************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Start vector service] ****************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [debug] *******************************************************************************************************************************************************************
ok: [clickhouse-01] => {
    "service_status_var.status.ActiveState": "active"
}

PLAY RECAP *********************************************************************************************************************************************************************
clickhouse-01              : ok=11   changed=0    unreachable=0    failed=0    skipped=0    rescued=1    ignored=0   

```

8. Повторно запустите playbook с флагом `--diff` и убедитесь, что playbook идемпотентен.

```bash
bvm@bvm-HP-EliteBook-8470p:~/netology/ansible_8_2/playbook$ ansible-playbook site.yml -i ./inventory/prod.yml --diff
PLAY [Install Clickhouse] ******************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get clickhouse distrib] **************************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-client)
ok: [clickhouse-01] => (item=clickhouse-server)
failed: [clickhouse-01] (item=clickhouse-common-static) => {"ansible_loop_var": "item", "changed": false, "dest": "./clickhouse-common-static-22.3.3.44.deb", "elapsed": 0, "gid": 1001, "group": "ubuntu", "item": "clickhouse-common-static", "mode": "0664", "msg": "Request failed", "owner": "ubuntu", "response": "HTTP Error 404: Not Found", "size": 246378832, "state": "file", "status_code": 404, "uid": 1000, "url": "https://packages.clickhouse.com/deb/pool/stable/clickhouse-common-static_22.3.3.44_all.deb"}

TASK [Get clickhouse distrib] **************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install clickhouse packages] *********************************************************************************************************************************************
ok: [clickhouse-01] => (item=clickhouse-common-static-22.3.3.44.deb)
ok: [clickhouse-01] => (item=clickhouse-client-22.3.3.44.deb)
ok: [clickhouse-01] => (item=clickhouse-server-22.3.3.44.deb)

TASK [Start clickhouse service] ************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [debug] *******************************************************************************************************************************************************************
ok: [clickhouse-01] => {
    "service_status_var.status.ActiveState": "active"
}

TASK [Create database] *********************************************************************************************************************************************************
ok: [clickhouse-01]

PLAY [Install latest Vector] ***************************************************************************************************************************************************

TASK [Gathering Facts] *********************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Get vector distrib] ******************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Install vector package] **************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [Start vector service] ****************************************************************************************************************************************************
ok: [clickhouse-01]

TASK [debug] *******************************************************************************************************************************************************************
ok: [clickhouse-01] => {
    "service_status_var.status.ActiveState": "active"
}

PLAY RECAP *********************************************************************************************************************************************************************
clickhouse-01              : ok=11   changed=0    unreachable=0    failed=0    skipped=0    rescued=1    ignored=0   

```

9. Подготовьте README.md файл по своему playbook. В нём должно быть описано: что делает playbook, какие у него есть параметры и теги.

[README.md](https://github.com/bvmspb/ansible_8_2/blob/master/README.md)

10. Готовый playbook выложите в свой репозиторий, поставьте тег `08-ansible-02-playbook` на фиксирующий коммит, в ответ предоставьте ссылку на него.

[Repository](https://github.com/bvmspb/ansible_8_2)
[Playbook](https://github.com/bvmspb/ansible_8_2/tree/master/playbook)
[Tag](https://github.com/bvmspb/ansible_8_2/releases/tag/08-ansible-02-playbook)

---
