# devops-netology DEVSYS-PDC-2

### DEVSYS-PDC-2 db 06.05 Vladimir Baksheev / Владимир Бакшеев Домашнее задание к занятию «6.5. Elasticsearch»

# Домашнее задание к занятию "6.5. Elasticsearch"

## Задача 1

В этом задании вы потренируетесь в:
- установке elasticsearch
- первоначальном конфигурировании elastcisearch
- запуске elasticsearch в docker

Используя докер образ [elasticsearch:7](https://hub.docker.com/_/elasticsearch) как базовый:

```answer1-1
    На этом этапе возникли проблемы из-за того, что был заблокирован доступ к 
    репозиторию с Эластиком. Помогло собрать образ на удаленной ВМ в другой 
    стране.
```
```answer1-2
    Проблема при попытке подготовить образ:
        bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology/06_db_05_elasticsearch$ docker build -t hw_06_db_05_elastic .
        Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Post "http://%2Fvar%2Frun%2Fdocker.sock/v1.24/build?buildargs=%7B%7D&cachefrom=%5B%5D&cgroupparent=&cpuperiod=0&cpuquota=0&cpusetcpus=&cpusetmems=&cpushares=0&dockerfile=Dockerfile&labels=%7B%7D&memory=0&memswap=0&networkmode=default&rm=1&shmsize=0&t=hw_06_db_05_elastic&target=&ulimits=null&version=1": dial unix /var/run/docker.sock: connect: permission denied
        bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology/06_db_05_elasticsearch$ sudo docker build -t hw_06_db_05_elastic .
        [sudo] password for bvm:     
        Sending build context to Docker daemon  3.584kB
        Step 1/2 : FROM docker.elastic.co/elasticsearch/elasticsearch:7.17.5@sha256:76344d5f89b13147743db0487eb76b03a7f9f0cd55abe8ab887069711f2ee27d
        docker.elastic.co/elasticsearch/elasticsearch:7.17.5@sha256:76344d5f89b13147743db0487eb76b03a7f9f0cd55abe8ab887069711f2ee27d: Pulling from elasticsearch/elasticsearch
        5486d18d7ee8: Pulling fs layer 
        059ab60189a6: Pulling fs layer 
        f68717dc7875: Pulling fs layer 
        543411f2e134: Waiting 
        db298b0bce73: Waiting 
        841c800fd413: Waiting 
        9401277c6728: Waiting 
        d677f77adbd8: Waiting 
        f0aaff8ec792: Waiting 
        error pulling image configuration: error parsing HTTP 403 response body: invalid character '<' looking for beginning of value: "<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\" \"http://www.w3.org/TR/html4/loose.dtd\">\n<HTML><HEAD><META HTTP-EQUIV=\"Content-Type\" CONTENT=\"text/html; charset=iso-8859-1\">\n<TITLE>ERROR: The request could not be satisfied</TITLE>\n</HEAD><BODY>\n<H1>403 ERROR</H1>\n<H2>The request could not be satisfied.</H2>\n<HR noshade size=\"1px\">\nThe Amazon CloudFront distribution is configured to block access from your country.\nWe can't connect to the server for this app or website at this time. There might be too much traffic or a configuration error. Try again later, or contact the app or website owner.\n<BR clear=\"all\">\nIf you provide content to customers through CloudFront, you can find steps to troubleshoot and help prevent this error by reviewing the CloudFront documentation.\n<BR clear=\"all\">\n<HR noshade size=\"1px\">\n<PRE>\nGenerated by cloudfront (CloudFront)\nRequest ID: bVPlAo93T4YUq-ucZ8TysgojuYO1nXDqf37LeKPIazp_djVwzZm4zw==\n</PRE>\n<ADDRESS>\n</ADDRESS>\n</BODY></HTML>"

```
```answer1-3
    То, как удалось это обойти с удаленной ВМ в другой стране:
        ubuntu@vm1-amd-1-1:~/netology/devops-netology/06_db_05_elasticsearch$ sudo docker build -t hw_06_db_05_elastic .
        Sending build context to Docker daemon  3.584kB
        Step 1/2 : FROM docker.elastic.co/elasticsearch/elasticsearch:7.17.5@sha256:76344d5f89b13147743db0487eb76b03a7f9f0cd55abe8ab887069711f2ee27d
        docker.elastic.co/elasticsearch/elasticsearch:7.17.5@sha256:76344d5f89b13147743db0487eb76b03a7f9f0cd55abe8ab887069711f2ee27d: Pulling from elasticsearch/elasticsearch
        5486d18d7ee8: Pull complete 
        059ab60189a6: Pull complete 
        f68717dc7875: Pull complete 
        543411f2e134: Pull complete 
        db298b0bce73: Pull complete 
        841c800fd413: Pull complete 
        9401277c6728: Pull complete 
        d677f77adbd8: Pull complete 
        f0aaff8ec792: Pull complete 
        Digest: sha256:76344d5f89b13147743db0487eb76b03a7f9f0cd55abe8ab887069711f2ee27d
        Status: Downloaded newer image for docker.elastic.co/elasticsearch/elasticsearch:7.17.5@sha256:76344d5f89b13147743db0487eb76b03a7f9f0cd55abe8ab887069711f2ee27d
         ---> 11df7a62573d
        Step 2/2 : COPY --chown=elasticsearch:elasticsearch elasticsearch.yml /usr/share/elasticsearch/config/
         ---> 64f1f492bd1d
        Successfully built 64f1f492bd1d
        Successfully tagged hw_06_db_05_elastic:latest
        ubuntu@vm1-amd-1-1:~/netology/devops-netology/06_db_05_elasticsearch$ sudo docker tag hw_06_db_05_elastic bvmspb/homeworks:hw_06_db_05_elastic
        ubuntu@vm1-amd-1-1:~/netology/devops-netology/06_db_05_elasticsearch$ sudo docker push bvmspb/homeworks:hw_06_db_05_elastic
        The push refers to repository [docker.io/bvmspb/homeworks]
        9370d8d42f4d: Pushed 
        bca54c335b28: Pushed 
        de080e772c1a: Pushed 
        cfc1ead7498a: Pushed 
        245d80f411fb: Pushed 
        489e330647ba: Pushed 
        cff7c30e604c: Pushed 
        3a50035e8665: Pushed 
        7074040eb2b7: Pushed 
        af7ed92504ae: Pushed 
        hw_06_db_05_elastic: digest: sha256:a6c20c6b69a1e3dcb9c14670d98b8ab991aeb5c7ea3978dbf978d710e6a3fde1 size: 2411

```
```answer1-4
    Далее уже продолжил работу со своим образом на своем ноутбуке:
        bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology/06_db_05_elasticsearch$ sudo docker pull bvmspb/homeworks:hw_06_db_05_elastic
        [sudo] password for bvm:     
        hw_06_db_05_elastic: Pulling from bvmspb/homeworks
        d7bfe07ed847: Pull complete 
        21c25f0f3ffb: Pull complete 
        077c465e1121: Pull complete 
        b1e2871dbab9: Pull complete 
        e91224f8b61f: Pull complete 
        eb4bb25a3e8d: Pull complete 
        e61ded035ed1: Pull complete 
        52f52d6a680d: Pull complete 
        9111f77afc12: Pull complete 
        853662e98a6f: Pull complete 
        Digest: sha256:a6c20c6b69a1e3dcb9c14670d98b8ab991aeb5c7ea3978dbf978d710e6a3fde1
        Status: Downloaded newer image for bvmspb/homeworks:hw_06_db_05_elastic
        docker.io/bvmspb/homeworks:hw_06_db_05_elastic
        bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ sudo docker run --name elastic --rm -d -t -p 9200:9200 -p 9300:9300 bvmspb/homeworks:hw_06_db_05_elastic
        c95466339948d7d3cb6c139db5b0bf3722b20f1033930c5e306eaf8ae7e1e53c

```

- составьте Dockerfile-манифест для elasticsearch

```answer1-5
    # Elasticsearch 7.17.5
    
    # This image re-bundles the Docker image from the upstream provider, Elastic.
    FROM docker.elastic.co/elasticsearch/elasticsearch:7.17.5@sha256:76344d5f89b13147743db0487eb76b03a7f9f0cd55abe8ab887069711f2ee27d
    # Supported Bashbrew Architectures: amd64 arm64v8
    
    # The upstream image was built by:
    #   https://github.com/elastic/dockerfiles/tree/v7.17.5/elasticsearch
    
    # The build can be reproduced locally via:
    #   docker build 'https://github.com/elastic/dockerfiles.git#v7.17.5:elasticsearch'
    
    # For a full list of supported images and tags visit https://www.docker.elastic.co
    
    # For Elasticsearch documentation visit https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html
    
    # See https://github.com/docker-library/official-images/pull/4916 for more details.
    
    COPY --chown=elasticsearch:elasticsearch elasticsearch.yml /usr/share/elasticsearch/config/
    
    RUN mkdir /var/lib/elasticsearch
    RUN chown -R elasticsearch:elasticsearch /var/lib/elasticsearch
    
    RUN mkdir /var/log/elasticsearch
    RUN chown -R elasticsearch:elasticsearch /var/log/elasticsearch
```
```yaml
path:
    data: /var/lib/elasticsearch
    logs: /var/log/elasticsearch
    repo: /usr/share/elasticsearch

node:
    name: netology_test
network:
    host: 0.0.0.0

discovery:
    type: single-node

```
- соберите docker-образ и сделайте `push` в ваш docker.io репозиторий

```bash
sudo docker build -t hw_06_db_05_elastic .
sudo docker tag hw_06_db_05_elastic bvmspb/homeworks:hw_06_db_05_elastic
sudo docker push bvmspb/homeworks:hw_06_db_05_elastic

```

- запустите контейнер из получившегося образа и выполните запрос пути `/` c хост-машины

```bash
sudo docker pull bvmspb/homeworks:hw_06_db_05_elastic
sudo docker run --name elastic --rm -d -t -p 9200:9200 -p 9300:9300 bvmspb/homeworks:hw_06_db_05_elastic

```
```answer1-6
    bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ curl localhost:9200/
    {
      "name" : "netology_test",
      "cluster_name" : "elasticsearch",
      "cluster_uuid" : "0rVWKNs-RoOKT6YoBxcr_A",
      "version" : {
        "number" : "7.17.5",
        "build_flavor" : "default",
        "build_type" : "docker",
        "build_hash" : "8d61b4f7ddf931f219e3745f295ed2bbc50c8e84",
        "build_date" : "2022-06-23T21:57:28.736740635Z",
        "build_snapshot" : false,
        "lucene_version" : "8.11.1",
        "minimum_wire_compatibility_version" : "6.8.0",
        "minimum_index_compatibility_version" : "6.0.0-beta1"
      },
      "tagline" : "You Know, for Search"
    }
```

Требования к `elasticsearch.yml`:
- данные `path` должны сохраняться в `/var/lib` 
- имя ноды должно быть `netology_test`

В ответе приведите:
- текст Dockerfile манифеста

```answer1-7
    Сделано выше
```

- ссылку на образ в репозитории dockerhub

[hw_06_db_05_elastic](https://hub.docker.com/layers/252877488/bvmspb/homeworks/hw_06_db_05_elastic/images/sha256-07e2090b6bdc46a86826babf2662b05834f5979da34d04e01760c01a145a81f9?context=repo)
[bvmspb/homeworks](https://hub.docker.com/repository/docker/bvmspb/homeworks)

- ответ `elasticsearch` на запрос пути `/` в json виде

```answer1-8
    Сделано выше
```

Подсказки:
- при сетевых проблемах внимательно изучите кластерные и сетевые настройки в elasticsearch.yml
- при некоторых проблемах вам поможет docker директива ulimit
- elasticsearch в логах обычно описывает проблему и пути ее решения
- обратите внимание на настройки безопасности такие как `xpack.security.enabled` 
- если докер образ не запускается и падает с ошибкой 137 в этом случае может помочь настройка `-e ES_HEAP_SIZE`
- при настройке `path` возможно потребуется настройка прав доступа на директорию

Далее мы будем работать с данным экземпляром elasticsearch.

## Задача 2

В этом задании вы научитесь:
- создавать и удалять индексы
- изучать состояние кластера
- обосновывать причину деградации доступности данных

Ознакомтесь с [документацией](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-create-index.html) 
и добавьте в `elasticsearch` 3 индекса, в соответствии со таблицей:

| Имя | Количество реплик | Количество шард |
|-----|-------------------|-----------------|
| ind-1| 0 | 1 |
| ind-2 | 1 | 2 |
| ind-3 | 2 | 4 |

```answer2-1
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ curl -X PUT "http://localhost:9200/ind-1" -H 'Content-Type: application/json' -d '{ "settings": { "number_of_shards": 1, "number_of_replicas": 0 }}'
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ curl -X PUT "http://localhost:9200/ind-2" -H 'Content-Type: application/json' -d '{ "settings": { "number_of_shards": 2, "number_of_replicas": 1 }}'
{"acknowledged":true,"shards_acknowledged":true,"index":"ind-2"}
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ curl -X PUT "http://localhost:9200/ind-3" -H 'Content-Type: application/json' -d '{ "settings": { "number_of_shards": 4, "number_of_replicas": 2 }}'
{"acknowledged":true,"shards_acknowledged":true,"index":"ind-3"}
```

Получите список индексов и их статусов, используя API и **приведите в ответе** на задание.

[cat indices API](https://www.elastic.co/guide/en/elasticsearch/reference/8.3/cat-indices.html)
```bash
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ curl -X GET http://localhost:9200/_cat/indices
green  open .geoip_databases pK5DlfzzSNCtoJeW0Bkm-Q 1 0 40 0 37.7mb 37.7mb
green  open ind-1            O4wKu1F0QYyfAL7iQ1VV4w 1 0  0 0   226b   226b
yellow open ind-3            KMT7-fc9Rsmnr-j6frRmUw 4 2  0 0   904b   904b
yellow open ind-2            iDpjbPqWQdqrECyhlsirCA 2 1  0 0   452b   452b

```

Получите состояние кластера `elasticsearch`, используя API.

[Cluster health API](https://www.elastic.co/guide/en/elasticsearch/reference/8.3/cluster-health.html)
```bash
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ curl -X GET "localhost:9200/_cluster/health?pretty"
{
  "cluster_name" : "elasticsearch",
  "status" : "yellow",
  "timed_out" : false,
  "number_of_nodes" : 1,
  "number_of_data_nodes" : 1,
  "active_primary_shards" : 10,
  "active_shards" : 10,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 10,
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 50.0
}

```

Как вы думаете, почему часть индексов и кластер находится в состоянии yellow?

```answer2-2
По информации из Интернета - реплика не распределена по всем нодам 
кластера, либо в кластере только одна нода - все работает, но есть риск, 
потому и желтый цвет. В нашем случае как раз одна только нода в кластере.
```
[Ссылка](http://chrissimpson.co.uk/elasticsearch-yellow-cluster-status-explained.html)

Удалите все индексы.

```bash
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ curl -X DELETE "localhost:9200/*"
{"acknowledged":true} 
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ curl -X GET http://localhost:9200/_cat/indices
green open .geoip_databases pK5DlfzzSNCtoJeW0Bkm-Q 1 0 40 0 37.7mb 37.7mb
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ 

```

**Важно**

При проектировании кластера elasticsearch нужно корректно рассчитывать количество реплик и шард,
иначе возможна потеря данных индексов, вплоть до полной, при деградации системы.

## Задача 3

В данном задании вы научитесь:
- создавать бэкапы данных
- восстанавливать индексы из бэкапов

Создайте директорию `{путь до корневой директории с elasticsearch в образе}/snapshots`.

```bash
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ sudo exec -i -t elastic bash
sudo: exec: command not found
bvm@bvm-HP-EliteBook-8470p:~/netology/devops-netology$ sudo docker exec -i -t elastic bash
root@c95466339948:/usr/share/elasticsearch# which elasticsearch
/usr/share/elasticsearch/bin/elasticsearch
root@c95466339948:/usr/share/elasticsearch# mkdir /usr/share/elasticsearch/snapshots
root@c95466339948:/usr/share/elasticsearch# chown elasticsearch:elasticsearch /usr/share/elasticsearch/snapshots/

```

Используя API [зарегистрируйте](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-register-repository.html#snapshots-register-repository) 
данную директорию как `snapshot repository` c именем `netology_backup`.

**Приведите в ответе** запрос API и результат вызова API для создания репозитория.

```bash
bvm@bvm-HP-EliteBook-8470p:~$ curl -X PUT "localhost:9200/_snapshot/netology_backup?pretty" -H 'Content-Type: application/json' -d'{  "type": "fs",  "settings": {    "location":"/usr/share/elasticsearch/snapshots"  }}'
{
  "acknowledged" : true
}

```

Создайте индекс `test` с 0 реплик и 1 шардом и **приведите в ответе** список индексов.

```bash
bvm@bvm-HP-EliteBook-8470p:~$ curl -X PUT "localhost:9200/test?pretty" -H 'Content-Type: application/json' -d'{  "settings": {    "index": {      "number_of_shards": 1,        "number_of_replicas": 0     }  }}'
{
  "acknowledged" : true,
  "shards_acknowledged" : true,
  "index" : "test"
}
bvm@bvm-HP-EliteBook-8470p:~$ curl -X GET "localhost:9200/_cat/indices?pretty"
green open .geoip_databases xYj0wj0ZQX6uR1omhKTBIw 1 0 40 0 37.7mb 37.7mb
green open test             Rw2Fw16OTeS8IGcYokJOTA 1 0  0 0   226b   226b

```

[Создайте `snapshot`](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-take-snapshot.html) 
состояния кластера `elasticsearch`.

```bash
bvm@bvm-HP-EliteBook-8470p:~$ curl -X PUT "localhost:9200/_snapshot/netology_backup/snapshot?pretty"
{
  "accepted" : true
}
```

**Приведите в ответе** список файлов в директории со `snapshot`ами.

```bash
root@929f88ccbd00:/usr/share/elasticsearch# ls snapshots/ -l
total 48
-rw-rw-r-- 1 elasticsearch root  1420 Jul 13 18:00 index-0
-rw-rw-r-- 1 elasticsearch root     8 Jul 13 18:00 index.latest
drwxrwxr-x 6 elasticsearch root  4096 Jul 13 18:00 indices
-rw-rw-r-- 1 elasticsearch root 29282 Jul 13 18:00 meta-tvgIPGZHQVmsGKtk7ATwtA.dat
-rw-rw-r-- 1 elasticsearch root   707 Jul 13 18:00 snap-tvgIPGZHQVmsGKtk7ATwtA.dat

```

Удалите индекс `test` и создайте индекс `test-2`. **Приведите в ответе** список индексов.

```bash
root@929f88ccbd00:/usr/share/elasticsearch# curl -X DELETE "localhost:9200/test?pretty"
{
  "acknowledged" : true
}
root@929f88ccbd00:/usr/share/elasticsearch# curl -X PUT "localhost:9200/test-2?pretty" -H 'Content-Type: application/json' -d'{  "settings": {    "index": {      "number_of_shards": 1,        "number_of_replicas": 0     }  }}'
{
  "acknowledged" : true,
  "shards_acknowledged" : true,
  "index" : "test-2"
}
root@929f88ccbd00:/usr/share/elasticsearch# curl -X GET "localhost:9200/_cat/indices?pretty"
green open .geoip_databases xYj0wj0ZQX6uR1omhKTBIw 1 0 40 0 37.7mb 37.7mb
green open test-2           FyKJQzKuSRmXbM6Az8v5aw 1 0  0 0   226b   226b

```

[Восстановите](https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-restore-snapshot.html) состояние
кластера `elasticsearch` из `snapshot`, созданного ранее. 

**Приведите в ответе** запрос к API восстановления и итоговый список индексов.

```bash
root@929f88ccbd00:/usr/share/elasticsearch# curl -X POST "localhost:9200/_snapshot/netology_backup/snapshot/_restore?pretty" -H 'Content-Type: application/json' -d'{  "indices": "test",  "include_global_state": true}'
{
  "accepted" : true
}
root@929f88ccbd00:/usr/share/elasticsearch# curl -X GET "localhost:9200/_cat/indices?pretty"
green open .geoip_databases 0S8HwPacRQ6G53031mbo4w 1 0 40 0 37.7mb 37.7mb
green open test-2           FyKJQzKuSRmXbM6Az8v5aw 1 0  0 0   226b   226b
green open test             YRDwKs68QdOI150VEVkGuA 1 0  0 0   226b   226b

```

Подсказки:
- возможно вам понадобится доработать `elasticsearch.yml` в части директивы `path.repo` и перезапустить `elasticsearch`

```answer3
    Да, так и оказалось - потребовалось включить и этот параметр в 
    конфигурационный файл и перезапустить, т.к. на лету такой параметр 
    изменить нельзя.
```

---
